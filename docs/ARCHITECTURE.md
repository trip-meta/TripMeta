# TripMeta ç³»ç»Ÿæ¶æ„è®¾è®¡

## ğŸ“‹ ç›®å½•

- [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
- [åˆ†å±‚æ¶æ„](#åˆ†å±‚æ¶æ„)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
- [æœåŠ¡æ¶æ„](#æœåŠ¡æ¶æ„)
- [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
- [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)
- [å®‰å…¨æ¶æ„](#å®‰å…¨æ¶æ„)

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

TripMetaé‡‡ç”¨ç°ä»£åŒ–çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œç»“åˆä¾èµ–æ³¨å…¥ã€äº‹ä»¶é©±åŠ¨å’Œå¾®æœåŠ¡æ¨¡å¼ï¼Œæ„å»ºäº†ä¸€ä¸ªå¯æ‰©å±•ã€å¯ç»´æŠ¤çš„AIé©±åŠ¨VRæ—…æ¸¸å¹³å°ã€‚

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TripMeta Architecture                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Presentation Layer (è¡¨ç°å±‚)                                   â”‚
â”‚  â”œâ”€â”€ VR Interface          â”œâ”€â”€ Mobile Companion                â”‚
â”‚  â”‚   â”œâ”€â”€ Spatial UI        â”‚   â”œâ”€â”€ Control Panel               â”‚
â”‚  â”‚   â”œâ”€â”€ Voice Interface   â”‚   â”œâ”€â”€ Settings                    â”‚
â”‚  â”‚   â””â”€â”€ Gesture Control   â”‚   â””â”€â”€ Social Features             â”‚
â”‚  â”œâ”€â”€ Web Dashboard         â””â”€â”€ Admin Panel                     â”‚
â”‚  â”‚   â”œâ”€â”€ Analytics         â”œâ”€â”€ User Management                 â”‚
â”‚  â”‚   â”œâ”€â”€ Content Mgmt      â”œâ”€â”€ System Monitor                  â”‚
â”‚  â”‚   â””â”€â”€ User Profile      â””â”€â”€ Configuration                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application Layer (åº”ç”¨å±‚)                                    â”‚
â”‚  â”œâ”€â”€ AI Services           â”œâ”€â”€ VR Services                     â”‚
â”‚  â”‚   â”œâ”€â”€ GPT Integration   â”‚   â”œâ”€â”€ Interaction Manager         â”‚
â”‚  â”‚   â”œâ”€â”€ Speech Service    â”‚   â”œâ”€â”€ Gesture Recognition         â”‚
â”‚  â”‚   â”œâ”€â”€ Vision Service    â”‚   â”œâ”€â”€ Spatial UI Manager          â”‚
â”‚  â”‚   â””â”€â”€ Recommendation    â”‚   â””â”€â”€ Performance Optimizer       â”‚
â”‚  â”œâ”€â”€ User Management       â”œâ”€â”€ Content Management              â”‚
â”‚  â”‚   â”œâ”€â”€ Authentication    â”‚   â”œâ”€â”€ Scene Manager               â”‚
â”‚  â”‚   â”œâ”€â”€ Profile Service   â”‚   â”œâ”€â”€ Asset Manager               â”‚
â”‚  â”‚   â”œâ”€â”€ Preference Mgmt   â”‚   â”œâ”€â”€ Content Generator           â”‚
â”‚  â”‚   â””â”€â”€ Social Features   â”‚   â””â”€â”€ Version Control             â”‚
â”‚  â”œâ”€â”€ Analytics Service     â””â”€â”€ Notification Service            â”‚
â”‚  â”‚   â”œâ”€â”€ User Behavior     â”œâ”€â”€ Real-time Alerts               â”‚
â”‚  â”‚   â”œâ”€â”€ Performance       â”œâ”€â”€ System Events                   â”‚
â”‚  â”‚   â””â”€â”€ Business Metrics  â””â”€â”€ User Notifications              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)                             â”‚
â”‚  â”œâ”€â”€ Core Framework        â”œâ”€â”€ Configuration                   â”‚
â”‚  â”‚   â”œâ”€â”€ Dependency Inject â”‚   â”œâ”€â”€ Environment Config          â”‚
â”‚  â”‚   â”œâ”€â”€ Service Container â”‚   â”œâ”€â”€ Feature Flags               â”‚
â”‚  â”‚   â”œâ”€â”€ Event Bus         â”‚   â”œâ”€â”€ API Keys Management         â”‚
â”‚  â”‚   â””â”€â”€ Service Locator   â”‚   â””â”€â”€ Runtime Settings            â”‚
â”‚  â”œâ”€â”€ Error Handling        â”œâ”€â”€ Performance Monitoring          â”‚
â”‚  â”‚   â”œâ”€â”€ Global Exception  â”‚   â”œâ”€â”€ Metrics Collection          â”‚
â”‚  â”‚   â”œâ”€â”€ Logging System    â”‚   â”œâ”€â”€ Performance Profiler       â”‚
â”‚  â”‚   â”œâ”€â”€ Recovery Strategy â”‚   â”œâ”€â”€ Memory Monitor              â”‚
â”‚  â”‚   â””â”€â”€ Health Check      â”‚   â””â”€â”€ Network Monitor             â”‚
â”‚  â”œâ”€â”€ Security Framework    â””â”€â”€ Caching System                  â”‚
â”‚  â”‚   â”œâ”€â”€ Authentication    â”œâ”€â”€ Memory Cache                    â”‚
â”‚  â”‚   â”œâ”€â”€ Authorization     â”œâ”€â”€ Distributed Cache               â”‚
â”‚  â”‚   â”œâ”€â”€ Data Encryption   â”œâ”€â”€ Asset Cache                     â”‚
â”‚  â”‚   â””â”€â”€ Audit Logging     â””â”€â”€ Query Cache                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Layer (æ•°æ®å±‚)                                           â”‚
â”‚  â”œâ”€â”€ Local Storage         â”œâ”€â”€ Cloud Storage                   â”‚
â”‚  â”‚   â”œâ”€â”€ SQLite Database   â”‚   â”œâ”€â”€ PostgreSQL                  â”‚
â”‚  â”‚   â”œâ”€â”€ File System       â”‚   â”œâ”€â”€ Redis Cache                 â”‚
â”‚  â”‚   â”œâ”€â”€ Player Prefs      â”‚   â”œâ”€â”€ Object Storage              â”‚
â”‚  â”‚   â””â”€â”€ Streaming Assets  â”‚   â””â”€â”€ CDN Assets                  â”‚
â”‚  â”œâ”€â”€ External APIs         â”œâ”€â”€ Message Queue                   â”‚
â”‚  â”‚   â”œâ”€â”€ OpenAI API        â”‚   â”œâ”€â”€ Event Streaming             â”‚
â”‚  â”‚   â”œâ”€â”€ Azure Services    â”‚   â”œâ”€â”€ Task Queue                  â”‚
â”‚  â”‚   â”œâ”€â”€ Analytics APIs    â”‚   â”œâ”€â”€ Notification Queue          â”‚
â”‚  â”‚   â””â”€â”€ Third-party APIs  â”‚   â””â”€â”€ Background Jobs             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›ï¸ åˆ†å±‚æ¶æ„

### è¡¨ç°å±‚ (Presentation Layer)

è´Ÿè´£ç”¨æˆ·ç•Œé¢å’Œäº¤äº’ä½“éªŒï¼ŒåŒ…æ‹¬VRç•Œé¢ã€ç§»åŠ¨ç«¯é…å¥—åº”ç”¨ã€Webç®¡ç†åå°ç­‰ã€‚

```csharp
namespace TripMeta.Presentation
{
    // VRç”¨æˆ·ç•Œé¢
    public interface IVRUserInterface
    {
        void ShowSpatialUI(UIPanel panel, Vector3 position);
        void HandleVoiceCommand(string command);
        void ProcessGesture(GestureData gesture);
    }
    
    // ç§»åŠ¨ç«¯ç•Œé¢
    public interface IMobileInterface
    {
        void ShowControlPanel();
        void SyncWithVRSession();
        void ManageSettings();
    }
    
    // Webç®¡ç†ç•Œé¢
    public interface IWebDashboard
    {
        void DisplayAnalytics();
        void ManageContent();
        void MonitorSystem();
    }
}
```

### åº”ç”¨å±‚ (Application Layer)

åŒ…å«ä¸šåŠ¡é€»è¾‘å’Œåº”ç”¨æœåŠ¡ï¼Œåè°ƒå„ä¸ªé¢†åŸŸæœåŠ¡å®Œæˆå…·ä½“çš„ä¸šåŠ¡åŠŸèƒ½ã€‚

```csharp
namespace TripMeta.Application
{
    // åº”ç”¨æœåŠ¡æ¥å£
    public interface IApplicationService
    {
        Task<Result<T>> ExecuteAsync<T>(ICommand<T> command);
        Task<T> QueryAsync<T>(IQuery<T> query);
    }
    
    // AIæœåŠ¡åè°ƒå™¨
    public class AIServiceOrchestrator : IApplicationService
    {
        private readonly IGPTService _gptService;
        private readonly ISpeechService _speechService;
        private readonly IVisionService _visionService;
        
        public async Task<TourGuideResponse> ProcessTourRequestAsync(TourRequest request)
        {
            // åè°ƒå¤šä¸ªAIæœåŠ¡å®Œæˆæ—…æ¸¸å¯¼è§ˆ
            var sceneAnalysis = await _visionService.AnalyzeSceneAsync(request.SceneImage);
            var tourContent = await _gptService.GenerateTourContentAsync(request.UserQuery, sceneAnalysis);
            var audioResponse = await _speechService.SynthesizeAsync(tourContent);
            
            return new TourGuideResponse
            {
                TextContent = tourContent,
                AudioContent = audioResponse,
                SceneInsights = sceneAnalysis
            };
        }
    }
}
```

### åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)

æä¾›æŠ€æœ¯åŸºç¡€è®¾æ–½æ”¯æŒï¼ŒåŒ…æ‹¬ä¾èµ–æ³¨å…¥ã€é…ç½®ç®¡ç†ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ç›‘æ§ç­‰ã€‚

```csharp
namespace TripMeta.Infrastructure
{
    // æœåŠ¡å®¹å™¨
    public class ServiceContainer : IServiceContainer
    {
        private readonly Dictionary<Type, ServiceDescriptor> _services;
        private readonly Dictionary<Type, object> _singletonInstances;
        
        public void RegisterSingleton<TInterface, TImplementation>()
            where TImplementation : class, TInterface
        {
            _services[typeof(TInterface)] = new ServiceDescriptor
            {
                ServiceType = typeof(TInterface),
                ImplementationType = typeof(TImplementation),
                Lifetime = ServiceLifetime.Singleton
            };
        }
        
        public T GetService<T>()
        {
            var serviceType = typeof(T);
            if (!_services.ContainsKey(serviceType))
                throw new ServiceNotFoundException($"Service {serviceType.Name} not registered");
                
            return (T)CreateInstance(_services[serviceType]);
        }
    }
    
    // é…ç½®ç®¡ç†
    public class ConfigurationManager : IConfigurationManager
    {
        private readonly Dictionary<string, object> _configurations;
        
        public T GetValue<T>(string key, T defaultValue = default)
        {
            if (_configurations.TryGetValue(key, out var value))
            {
                return (T)Convert.ChangeType(value, typeof(T));
            }
            return defaultValue;
        }
    }
}
```

### æ•°æ®å±‚ (Data Layer)

è´Ÿè´£æ•°æ®å­˜å‚¨å’Œå¤–éƒ¨æœåŠ¡é›†æˆï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ã€‚

```csharp
namespace TripMeta.Data
{
    // æ•°æ®ä»“å‚¨æ¨¡å¼
    public interface IRepository<T> where T : class
    {
        Task<T> GetByIdAsync(string id);
        Task<IEnumerable<T>> GetAllAsync();
        Task<T> AddAsync(T entity);
        Task<T> UpdateAsync(T entity);
        Task DeleteAsync(string id);
    }
    
    // ç”¨æˆ·æ•°æ®ä»“å‚¨
    public class UserRepository : IRepository<User>
    {
        private readonly IDatabase _database;
        
        public async Task<User> GetByIdAsync(string id)
        {
            return await _database.QuerySingleAsync<User>(
                "SELECT * FROM Users WHERE Id = @Id", new { Id = id });
        }
    }
    
    // å¤–éƒ¨APIå®¢æˆ·ç«¯
    public class OpenAIClient : IOpenAIClient
    {
        private readonly HttpClient _httpClient;
        private readonly IConfiguration _config;
        
        public async Task<GPTResponse> GenerateCompletionAsync(GPTRequest request)
        {
            var json = JsonSerializer.Serialize(request);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            
            var response = await _httpClient.PostAsync("/v1/chat/completions", content);
            var responseJson = await response.Content.ReadAsStringAsync();
            
            return JsonSerializer.Deserialize<GPTResponse>(responseJson);
        }
    }
}
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—

### ä¾èµ–æ³¨å…¥å®¹å™¨

```csharp
// æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
public enum ServiceLifetime
{
    Transient,  // æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°å®ä¾‹
    Scoped,     // åœ¨ä½œç”¨åŸŸå†…å•ä¾‹
    Singleton   // å…¨å±€å•ä¾‹
}

// æœåŠ¡æè¿°ç¬¦
public class ServiceDescriptor
{
    public Type ServiceType { get; set; }
    public Type ImplementationType { get; set; }
    public ServiceLifetime Lifetime { get; set; }
    public Func<IServiceProvider, object> Factory { get; set; }
}

// é«˜çº§æœåŠ¡å®¹å™¨
public class AdvancedServiceContainer : IServiceContainer, IDisposable
{
    private readonly ConcurrentDictionary<Type, ServiceDescriptor> _services;
    private readonly ConcurrentDictionary<Type, object> _singletonInstances;
    private readonly ThreadLocal<Dictionary<Type, object>> _scopedInstances;
    
    public void RegisterFactory<T>(Func<IServiceProvider, T> factory, ServiceLifetime lifetime = ServiceLifetime.Transient)
    {
        _services[typeof(T)] = new ServiceDescriptor
        {
            ServiceType = typeof(T),
            Factory = provider => factory(provider),
            Lifetime = lifetime
        };
    }
    
    public T GetRequiredService<T>()
    {
        var service = GetService<T>();
        if (service == null)
            throw new InvalidOperationException($"Required service {typeof(T).Name} not found");
        return service;
    }
}
```

### äº‹ä»¶é©±åŠ¨æ¶æ„

```csharp
// äº‹ä»¶æ€»çº¿
public class EventBus : IEventBus
{
    private readonly ConcurrentDictionary<Type, List<IEventHandler>> _handlers;
    private readonly ILogger _logger;
    
    public void Subscribe<T>(IEventHandler<T> handler) where T : IEvent
    {
        var eventType = typeof(T);
        _handlers.AddOrUpdate(eventType, 
            new List<IEventHandler> { handler },
            (key, existing) => { existing.Add(handler); return existing; });
    }
    
    public async Task PublishAsync<T>(T eventData) where T : IEvent
    {
        var eventType = typeof(T);
        if (!_handlers.TryGetValue(eventType, out var handlers))
            return;
            
        var tasks = handlers.Cast<IEventHandler<T>>()
            .Select(handler => HandleEventSafelyAsync(handler, eventData));
            
        await Task.WhenAll(tasks);
    }
    
    private async Task HandleEventSafelyAsync<T>(IEventHandler<T> handler, T eventData) where T : IEvent
    {
        try
        {
            await handler.HandleAsync(eventData);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, $"Error handling event {typeof(T).Name}");
        }
    }
}

// äº‹ä»¶å¤„ç†å™¨
public interface IEventHandler<T> where T : IEvent
{
    Task HandleAsync(T eventData);
}

// é¢†åŸŸäº‹ä»¶
public class UserLoginEvent : IEvent
{
    public string UserId { get; set; }
    public DateTime LoginTime { get; set; }
    public string DeviceInfo { get; set; }
    public string IPAddress { get; set; }
}
```

### é…ç½®ç®¡ç†ç³»ç»Ÿ

```csharp
// åˆ†å±‚é…ç½®ç³»ç»Ÿ
public class HierarchicalConfigurationManager : IConfigurationManager
{
    private readonly List<IConfigurationSource> _sources;
    
    public HierarchicalConfigurationManager()
    {
        _sources = new List<IConfigurationSource>
        {
            new EnvironmentVariableSource(),
            new JsonFileSource("appsettings.json"),
            new JsonFileSource($"appsettings.{Environment.GetEnvironmentVariable("ENVIRONMENT")}.json"),
            new CommandLineSource(),
            new RemoteConfigSource()
        };
    }
    
    public T GetValue<T>(string key, T defaultValue = default)
    {
        foreach (var source in _sources)
        {
            if (source.TryGetValue(key, out var value))
            {
                return ConvertValue<T>(value);
            }
        }
        return defaultValue;
    }
    
    public void WatchForChanges(string key, Action<object> callback)
    {
        foreach (var source in _sources.OfType<IWatchableConfigurationSource>())
        {
            source.Watch(key, callback);
        }
    }
}

// é…ç½®æºæ¥å£
public interface IConfigurationSource
{
    bool TryGetValue(string key, out object value);
}

public interface IWatchableConfigurationSource : IConfigurationSource
{
    void Watch(string key, Action<object> callback);
}
```

## ğŸ“Š æ•°æ®æµè®¾è®¡

### ç”¨æˆ·äº¤äº’æ•°æ®æµ

```
ç”¨æˆ·VRäº¤äº’ â†’ è¾“å…¥å¤„ç† â†’ äº‹ä»¶æ€»çº¿ â†’ åº”ç”¨æœåŠ¡ â†’ AIæœåŠ¡ â†’ å“åº”ç”Ÿæˆ â†’ UIæ›´æ–°
     â†“           â†“          â†“         â†“        â†“        â†“         â†“
  æ‰‹åŠ¿/è¯­éŸ³   â†’ æ ‡å‡†åŒ–è¾“å…¥ â†’ äº‹ä»¶åˆ†å‘ â†’ ä¸šåŠ¡é€»è¾‘ â†’ AIå¤„ç† â†’ ç»“æœå°è£… â†’ ç•Œé¢æ¸²æŸ“
```

### AIæœåŠ¡æ•°æ®æµ

```csharp
// AIæœåŠ¡ç®¡é“
public class AIServicePipeline
{
    private readonly List<IAIProcessor> _processors;
    
    public async Task<AIResponse> ProcessAsync(AIRequest request)
    {
        var context = new AIProcessingContext(request);
        
        foreach (var processor in _processors)
        {
            context = await processor.ProcessAsync(context);
            
            if (context.ShouldTerminate)
                break;
        }
        
        return context.Response;
    }
}

// AIå¤„ç†å™¨æ¥å£
public interface IAIProcessor
{
    Task<AIProcessingContext> ProcessAsync(AIProcessingContext context);
}

// å…·ä½“å¤„ç†å™¨å®ç°
public class InputValidationProcessor : IAIProcessor
{
    public async Task<AIProcessingContext> ProcessAsync(AIProcessingContext context)
    {
        if (string.IsNullOrEmpty(context.Request.Input))
        {
            context.Response.Error = "Input cannot be empty";
            context.ShouldTerminate = true;
        }
        
        return context;
    }
}

public class ContentFilterProcessor : IAIProcessor
{
    public async Task<AIProcessingContext> ProcessAsync(AIProcessingContext context)
    {
        // å†…å®¹è¿‡æ»¤é€»è¾‘
        if (ContainsInappropriateContent(context.Request.Input))
        {
            context.Response.Error = "Content filtered";
            context.ShouldTerminate = true;
        }
        
        return context;
    }
}
```

## ğŸŒ æœåŠ¡æ¶æ„

### å¾®æœåŠ¡é€šä¿¡

```csharp
// æœåŠ¡é—´é€šä¿¡æ¥å£
public interface IServiceCommunication
{
    Task<TResponse> CallAsync<TRequest, TResponse>(string serviceName, string method, TRequest request);
    Task PublishEventAsync<T>(T eventData) where T : IEvent;
    void Subscribe<T>(Func<T, Task> handler) where T : IEvent;
}

// HTTPæœåŠ¡é€šä¿¡
public class HttpServiceCommunication : IServiceCommunication
{
    private readonly HttpClient _httpClient;
    private readonly IServiceDiscovery _serviceDiscovery;
    
    public async Task<TResponse> CallAsync<TRequest, TResponse>(string serviceName, string method, TRequest request)
    {
        var serviceUrl = await _serviceDiscovery.GetServiceUrlAsync(serviceName);
        var requestJson = JsonSerializer.Serialize(request);
        var content = new StringContent(requestJson, Encoding.UTF8, "application/json");
        
        var response = await _httpClient.PostAsync($"{serviceUrl}/{method}", content);
        var responseJson = await response.Content.ReadAsStringAsync();
        
        return JsonSerializer.Deserialize<TResponse>(responseJson);
    }
}

// æœåŠ¡å‘ç°
public interface IServiceDiscovery
{
    Task<string> GetServiceUrlAsync(string serviceName);
    Task RegisterServiceAsync(string serviceName, string url);
    Task<bool> IsServiceHealthyAsync(string serviceName);
}
```

### è´Ÿè½½å‡è¡¡å’Œå®¹é”™

```csharp
// æ–­è·¯å™¨æ¨¡å¼
public class CircuitBreaker
{
    private readonly int _failureThreshold;
    private readonly TimeSpan _timeout;
    private int _failureCount;
    private DateTime _lastFailureTime;
    private CircuitBreakerState _state;
    
    public async Task<T> ExecuteAsync<T>(Func<Task<T>> operation)
    {
        if (_state == CircuitBreakerState.Open)
        {
            if (DateTime.UtcNow - _lastFailureTime > _timeout)
            {
                _state = CircuitBreakerState.HalfOpen;
            }
            else
            {
                throw new CircuitBreakerOpenException();
            }
        }
        
        try
        {
            var result = await operation();
            OnSuccess();
            return result;
        }
        catch (Exception)
        {
            OnFailure();
            throw;
        }
    }
    
    private void OnSuccess()
    {
        _failureCount = 0;
        _state = CircuitBreakerState.Closed;
    }
    
    private void OnFailure()
    {
        _failureCount++;
        _lastFailureTime = DateTime.UtcNow;
        
        if (_failureCount >= _failureThreshold)
        {
            _state = CircuitBreakerState.Open;
        }
    }
}

public enum CircuitBreakerState
{
    Closed,
    Open,
    HalfOpen
}
```

## ğŸš€ éƒ¨ç½²æ¶æ„

### å®¹å™¨åŒ–éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'
services:
  tripmeta-app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - ENVIRONMENT=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - database
      - redis
      - ai-service
    
  ai-service:
    image: tripmeta/ai-service:latest
    ports:
      - "8081:8081"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY}
    
  database:
    image: postgres:13
    environment:
      - POSTGRES_DB=tripmeta
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - tripmeta-app

volumes:
  postgres_data:
```

### Kuberneteséƒ¨ç½²

```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tripmeta-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tripmeta
  template:
    metadata:
      labels:
        app: tripmeta
    spec:
      containers:
      - name: tripmeta
        image: tripmeta:latest
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: tripmeta-secrets
              key: database-url
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: tripmeta-service
spec:
  selector:
    app: tripmeta
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: LoadBalancer
```

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•ç­–ç•¥

```csharp
// åˆ†ç‰‡ç­–ç•¥
public class ShardingStrategy
{
    private readonly List<string> _shards;
    
    public string GetShardForUser(string userId)
    {
        var hash = userId.GetHashCode();
        var shardIndex = Math.Abs(hash) % _shards.Count;
        return _shards[shardIndex];
    }
    
    public string GetShardForData(string dataKey)
    {
        // ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
        return ConsistentHash.GetShard(dataKey, _shards);
    }
}

// ç¼“å­˜åˆ†å±‚
public class TieredCacheManager
{
    private readonly IMemoryCache _l1Cache;      // å†…å­˜ç¼“å­˜
    private readonly IDistributedCache _l2Cache; // Redisç¼“å­˜
    private readonly IObjectStorage _l3Cache;    // å¯¹è±¡å­˜å‚¨
    
    public async Task<T> GetAsync<T>(string key)
    {
        // L1ç¼“å­˜
        if (_l1Cache.TryGetValue(key, out T value))
            return value;
            
        // L2ç¼“å­˜
        var l2Value = await _l2Cache.GetAsync<T>(key);
        if (l2Value != null)
        {
            _l1Cache.Set(key, l2Value, TimeSpan.FromMinutes(5));
            return l2Value;
        }
        
        // L3ç¼“å­˜
        var l3Value = await _l3Cache.GetAsync<T>(key);
        if (l3Value != null)
        {
            await _l2Cache.SetAsync(key, l3Value, TimeSpan.FromHours(1));
            _l1Cache.Set(key, l3Value, TimeSpan.FromMinutes(5));
            return l3Value;
        }
        
        return default(T);
    }
}
```

## ğŸ”’ å®‰å…¨æ¶æ„

### è®¤è¯å’Œæˆæƒ

```csharp
// JWTè®¤è¯
public class JwtAuthenticationService : IAuthenticationService
{
    private readonly string _secretKey;
    private readonly string _issuer;
    
    public async Task<AuthenticationResult> AuthenticateAsync(LoginRequest request)
    {
        var user = await ValidateCredentialsAsync(request.Username, request.Password);
        if (user == null)
            return AuthenticationResult.Failed("Invalid credentials");
            
        var token = GenerateJwtToken(user);
        return AuthenticationResult.Success(token, user);
    }
    
    private string GenerateJwtToken(User user)
    {
        var tokenHandler = new JwtSecurityTokenHandler();
        var key = Encoding.ASCII.GetBytes(_secretKey);
        
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim(ClaimTypes.NameIdentifier, user.Id),
                new Claim(ClaimTypes.Name, user.Username),
                new Claim(ClaimTypes.Role, user.Role)
            }),
            Expires = DateTime.UtcNow.AddHours(24),
            Issuer = _issuer,
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), 
                SecurityAlgorithms.HmacSha256Signature)
        };
        
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }
}

// åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
public class RoleBasedAuthorizationService : IAuthorizationService
{
    private readonly Dictionary<string, List<string>> _rolePermissions;
    
    public async Task<bool> AuthorizeAsync(string userId, string resource, string action)
    {
        var user = await GetUserAsync(userId);
        var requiredPermission = $"{resource}:{action}";
        
        if (_rolePermissions.TryGetValue(user.Role, out var permissions))
        {
            return permissions.Contains(requiredPermission) || permissions.Contains("*");
        }
        
        return false;
    }
}
```

### æ•°æ®åŠ å¯†

```csharp
// æ•°æ®åŠ å¯†æœåŠ¡
public class EncryptionService : IEncryptionService
{
    private readonly byte[] _key;
    private readonly byte[] _iv;
    
    public string Encrypt(string plainText)
    {
        using var aes = Aes.Create();
        aes.Key = _key;
        aes.IV = _iv;
        
        using var encryptor = aes.CreateEncryptor();
        using var msEncrypt = new MemoryStream();
        using var csEncrypt = new CryptoStream(msEncrypt, encryptor, CryptoStreamMode.Write);
        using var swEncrypt = new StreamWriter(csEncrypt);
        
        swEncrypt.Write(plainText);
        return Convert.ToBase64String(msEncrypt.ToArray());
    }
    
    public string Decrypt(string cipherText)
    {
        var cipherBytes = Convert.FromBase64String(cipherText);
        
        using var aes = Aes.Create();
        aes.Key = _key;
        aes.IV = _iv;
        
        using var decryptor = aes.CreateDecryptor();
        using var msDecrypt = new MemoryStream(cipherBytes);
        using var csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read);
        using var srDecrypt = new StreamReader(csDecrypt);
        
        return srDecrypt.ReadToEnd();
    }
}
```

---

*æœ¬æ¶æ„æ–‡æ¡£ä¼šéšç€ç³»ç»Ÿæ¼”è¿›æŒç»­æ›´æ–°ï¼Œç¡®ä¿æ¶æ„è®¾è®¡ä¸å®é™…å®ç°ä¿æŒä¸€è‡´ã€‚*